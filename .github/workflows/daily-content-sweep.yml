name: Daily Content Sweep

on:
  schedule:
    # Run daily at 7 AM UTC (2 hours after image generation at 5 AM)
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      target_collection:
        description: 'Specific collection to process (leave empty for all)'
        required: false
        default: ''

env:
  # Feature flag to enable/disable the workflow
  ENABLE_CONTENT_SWEEP: true

jobs:
  content-sweep:
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_CONTENT_SWEEP != 'false' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_GITHUB }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .dev.vars file
        run: |
          cat << EOF > .dev.vars
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          CF_ACCOUNT_ID=${{ secrets.CF_ACCOUNT_ID }}
          CF_IMAGES_TOKEN=${{ secrets.CF_IMAGES_TOKEN }}
          R2_ACCESS_KEY=${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY=${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
          R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}
          EOF

      - name: Run Content Sweep
        id: sweep
        run: |
          if [ -n "${{ github.event.inputs.target_collection }}" ]; then
            export TARGET_COLLECTION="${{ github.event.inputs.target_collection }}"
          fi
          npm run content:sweep 2>&1 | tee sweep-output.log
          
          # Check if any collections were processed
          if grep -q "Processed [1-9]" sweep-output.log; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Sweep Manifest
        if: steps.sweep.outputs.changes_made == 'true'
        run: |
          mkdir -p mission-control/logs
          DATE=$(date +%Y-%m-%d)
          cat << EOF > mission-control/logs/content-sweep-${DATE}.json
          {
            "date": "${DATE}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run": "${{ github.run_id }}",
            "target_collection": "${{ github.event.inputs.target_collection || 'all' }}",
            "status": "completed"
          }
          EOF

      - name: Commit Changes
        if: steps.sweep.outputs.changes_made == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add content/
          git add mission-control/logs/
          
          DATE=$(date +%Y-%m-%d)
          git commit -m "chore(content): daily content sweep - ${DATE}" || echo "No changes to commit"
          git push origin main

      - name: Summary
        run: |
          echo "### Content Sweep Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.sweep.outputs.changes_made }}" == "true" ]; then
            echo "✅ Content was generated and committed." >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No collections needed processing." >> $GITHUB_STEP_SUMMARY
          fi
