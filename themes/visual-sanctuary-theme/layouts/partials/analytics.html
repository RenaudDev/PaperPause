<!-- Implied Consent Analytics for GA4 + Pinterest -->
<script>
    /**
     * Cookie Consent Manager (Implied Consent Model)
     * - Analytics load by default unless user has opted out
     * - Stores consent in localStorage with 180-day expiry
     * - Users can opt-out via cookie banner
     */

    // Configuration
    const CONSENT_KEY = 'pp_cookie_consent';
    const CONSENT_EXPIRY_DAYS = 180;
    const CONSENT_STATES = {
        ACCEPTED: 'accepted',
        REJECTED: 'rejected'
    };
    const GA4_ID = '{{ site.Config.Services.GoogleAnalytics.ID | default site.Params.googleAnalytics }}';

    // Get current consent state (returns 'accepted', 'rejected', or null)
    function getConsentState() {
        const stored = localStorage.getItem(CONSENT_KEY);
        if (!stored) return null;
        
        try {
            const parsed = JSON.parse(stored);
            
            const expiryDate = new Date(parsed.timestamp);
            expiryDate.setDate(expiryDate.getDate() + CONSENT_EXPIRY_DAYS);
            
            if (new Date() >= expiryDate) {
                localStorage.removeItem(CONSENT_KEY);
                return null;
            }
            
            return parsed.value;
        } catch (e) {
            return null;
        }
    }

    // Check if user has NOT explicitly rejected (implied consent)
    function shouldLoadAnalytics() {
        const state = getConsentState();
        return state !== CONSENT_STATES.REJECTED;
    }

    // Store consent decision
    function setConsentDecision(decision) {
        localStorage.setItem(CONSENT_KEY, JSON.stringify({
            value: decision,
            timestamp: new Date().toISOString()
        }));
    }

    // Load GA4 - FIXED: Use window.gtag check to avoid hoisting issue
    function ppLoadGA4() {
        if (window.gtag) return; // Already loaded

        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA4_ID;
        document.head.appendChild(script);

        window.dataLayer = window.dataLayer || [];
        window.gtag = function() { dataLayer.push(arguments); };
        window.gtag('js', new Date());

        window.gtag('config', GA4_ID, {
            'send_page_view': true,
            'enhanced_measurement': {
                'scrolls': true,
                'outbound_clicks': false,
                'site_search': true,
                'video_engagement': false,
                'file_downloads': false
            }
        });
    }

    // Disable GA4 tracking (for opt-out)
    function ppDisableGA4() {
        window['ga-disable-' + GA4_ID] = true;
    }

    // Load Pinterest Tag
    function ppLoadPinterest() {
        if (window.pintrk) return; // Already loaded

        !function(e){if(!window.pintrk){window.pintrk = function () {
        window.pintrk.queue.push(Array.prototype.slice.call(arguments))};var
          n=window.pintrk;n.queue=[],n.version="3.0";var
          t=document.createElement("script");t.async=!0,t.src=e;var
          r=document.getElementsByTagName("script")[0];
          r.parentNode.insertBefore(t,r)}}("https://s.pinimg.com/ct/core.js");
        
        pintrk('load', '{{ .Site.Params.pinterestTag }}');
        pintrk('page');

        // Pinterest noscript fallback
        const noscript = document.createElement('img');
        noscript.height = 1;
        noscript.width = 1;
        noscript.style.display = 'none';
        noscript.alt = '';
        noscript.src = 'https://ct.pinterest.com/v3/?event=init&tid={{ .Site.Params.pinterestTag }}&noscript=1';
        document.body.appendChild(noscript);
    }

    // Load analytics (implied consent - load unless rejected)
    function ppLoadAnalytics() {
        if (shouldLoadAnalytics()) {
            {{ if or site.Config.Services.GoogleAnalytics.ID site.Params.googleAnalytics }}ppLoadGA4();{{ end }}
            {{ if .Site.Params.pinterestTag }}ppLoadPinterest();{{ end }}
        }
    }

    // Expose globally so banner can call this
    window.ppSetConsentAndLoad = function(decision) {
        setConsentDecision(decision);
        if (decision === CONSENT_STATES.ACCEPTED) {
            ppLoadAnalytics();
        } else if (decision === CONSENT_STATES.REJECTED) {
            ppDisableGA4();
        }
        // Dispatch event so other scripts can listen
        window.dispatchEvent(new CustomEvent('ppConsentChanged', { detail: decision }));
    };

    window.ppGetConsentState = function() {
        return getConsentState();
    };

    window.ppShouldLoadAnalytics = function() {
        return shouldLoadAnalytics();
    };

    window.ppOpenCookieBanner = function() {
        window.dispatchEvent(new CustomEvent('ppOpenBanner'));
    };

    // Expose GA4 ID for other scripts
    window.ppGA4ID = GA4_ID;

    // Mark consent manager as ready
    window.ppConsentManagerReady = true;

    // Load analytics on page load (implied consent)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ppLoadAnalytics);
    } else {
        ppLoadAnalytics();
    }
</script>
